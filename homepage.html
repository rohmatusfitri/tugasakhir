<!DOCTYPE html>
<html lang="en">
    <div id="dashboard-page" class="main-container">
        <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinchan Security System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- MQTT Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --info-color: #0891b2;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
            min-height: calc(100vh - 40px);
        }

        .status-card {
            transition: all 0.3s ease;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: none;
            overflow: hidden;
            position: relative;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .sensor-active {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .sensor-inactive {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #7f1d1d;
        }

        .sensor-motion {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            animation: motionSequence 2s infinite;
        }
        
        .sensor-sequence {
            background: linear-gradient(135deg, #fecaca 0%, #f87171 100%);
            color: #7f1d1d;
            animation: sequenceActive 1.5s infinite;
        }

        @keyframes motionSequence {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
            }
            25% { 
                opacity: 0.8; 
                transform: scale(1.02);
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            }
            50% { 
                opacity: 0.9; 
                transform: scale(1.01);
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            }
            75% { 
                opacity: 0.85; 
                transform: scale(1.02);
                box-shadow: 0 0 25px rgba(251, 191, 36, 0.9);
            }
        }
        
        @keyframes sequenceActive {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.03);
                box-shadow: 0 0 25px rgba(239, 68, 68, 1);
            }
        }

        .sirene-active {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .sirene-inactive {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #475569;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .connection-online {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
        }

        .connection-offline {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        .control-button {
            transition: all 0.3s ease;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 24px;
            border: none;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .control-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .control-button:hover::before {
            left: 100%;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            text-decoration: none;
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .calendar-has-activity {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
            border-radius: 50%;
            cursor: pointer;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); }
        }

        .icon-wrapper {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .dashboard-title {
            background: linear-gradient(135deg, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .config-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a, #15803d);
            border: none;
        }

        .btn-warning {
            background: linear-gradient(135deg, #d97706, #b45309);
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            border: none;
        }
        
        /* Custom toast notification colors */
        .toast.text-bg-secondary {
            background-color: #6b7280 !important;
            color: white !important;
        }
        
        .toast.text-bg-danger {
            background-color: #dc2626 !important;
            color: white !important;
        }

        .btn-info {
            background: linear-gradient(135deg, #0891b2, #0e7490);
            border: none;
            color: white;
        }

        /* Loading overlay for smooth transitions */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        /* User info badge */
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        .user-role {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Role-based access indicators */
        .restricted-control {
            position: relative;
        }

        .restricted-control::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: var(--danger-color);
            border-radius: 50%;
            border: 2px solid white;
        }

        .access-denied-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .access-denied-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--danger-color);
        }

        .restricted-control:hover .access-denied-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Notification permission panel */
        .notification-panel {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .notification-panel.show {
            display: block;
        }

        .notification-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .notification-granted {
            background: #16a34a;
            color: white;
        }

        .notification-denied {
            background: #dc2626;
            color: white;
        }

        .notification-default {
            background: #d97706;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Restoring dashboard state...</div>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connection-offline">
        <i class="fas fa-circle me-2"></i>
        <span>Offline</span>
    </div>

    <div class="main-container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="dashboard-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Sinchan Security System
                </h1>
                <p class="text-muted mb-0">Real-time monitoring dashboard</p>
            </div>
            <div class="text-end">
                <div class="user-info mb-2">
                    <i class="fas fa-user me-1"></i>
                    <span id="currentUserName">Loading...</span>
                    <span class="user-role" id="userRole">Admin</span>
                </div>
                <div id="lastUpdate" class="text-muted small">
                    Last update: Never
                </div>
                <div class="mt-2">
                    <button class="btn btn-outline-primary btn-sm me-1" id="adminPanelBtn" onclick="navigateToAdminPanel()" style="display: none;">
                        <i class="fas fa-user-shield me-1"></i>
                        Admin Panel
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Desktop Notification Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-bell me-2"></i>
                        Desktop Notifications
                        <span class="notification-status" id="notificationStatus">Unknown</span>
                    </h6>
                    <p class="mb-0 small">Enable desktop notifications to receive alerts even when you're in other tabs or applications</p>
                </div>
                <div>
                    <button class="btn btn-warning btn-sm" id="enableNotificationsBtn" onclick="requestNotificationPermission()">
                        <i class="fas fa-bell me-1"></i>
                        Enable Notifications
                    </button>
                    <button class="btn btn-outline-secondary btn-sm ms-1" onclick="hideNotificationPanel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- MQTT Configuration Panel -->
        <div class="config-panel">
            <h5 class="mb-3">
                <i class="fas fa-cog me-2"></i>
                MQTT Configuration
            </h5>
            <div class="row">
                <div class="col-md-3">
                    <input type="text" id="mqttHost" class="form-control form-control-sm" placeholder="MQTT Host" value="broker.hivemq.com">
                </div>
                <div class="col-md-2">
                    <input type="number" id="mqttPort" class="form-control form-control-sm" placeholder="Port" value="8884">
                </div>
                <div class="col-md-3">
                    <input type="text" id="mqttUsername" class="form-control form-control-sm" placeholder="Username (optional)">
                </div>
                <div class="col-md-2">
                    <input type="password" id="mqttPassword" class="form-control form-control-sm" placeholder="Password (optional)">
                </div>
                <div class="col-md-2">
                    <button id="btnConnect" class="btn btn-primary btn-sm w-100" onclick="connectMQTT()">
                        <i class="fas fa-plug me-1"></i>
                        Connect
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div id="sensorStatus" class="status-card sensor-inactive p-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper">
                            <i class="fas fa-radar-chart fa-2x" id="sensorIcon"></i>
                        </div>
                        <div>
                            <h4 class="mb-1" id="sensorText">INACTIVE</h4>
                            <p class="text-uppercase mb-0 small fw-bold letter-spacing-1">
                                Motion Sensor
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div id="sireneStatus" class="status-card sirene-inactive p-4 h-100">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper">
                            <i class="fas fa-bullhorn fa-2x" id="sireneIcon"></i>
                        </div>
                        <div>
                            <h4 class="mb-1" id="sireneText">INACTIVE</h4>
                            <p class="text-uppercase mb-0 small fw-bold letter-spacing-1">
                                Alarm Siren
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-center flex-wrap gap-3">
                    <!-- Always available buttons -->
                    <button id="btnCapture" class="control-button btn btn-primary">
                        <i class="fas fa-camera me-2"></i>
                        Capture Image
                    </button>
                    
                    <button class="control-button btn btn-info" onclick="navigateToGallery()">
                        <i class="fas fa-images me-2"></i>
                        Lihat Galeri Gambar
                    </button>

                    <!-- Super Admin only buttons -->
                    <div id="superAdminControls" style="display: none;">
                        <button id="btnSensorOn" class="control-button btn btn-success">
                            <i class="fas fa-play me-2"></i>
                            Sensor ON
                        </button>
                        <button id="btnSensorOff" class="control-button btn btn-secondary">
                            <i class="fas fa-stop me-2"></i>
                            Sensor OFF
                        </button>
                        <button id="btnSireneToggle" class="control-button btn btn-warning">
                            <i class="fas fa-volume-up me-2"></i>
                            Toggle Siren
                        </button>
                    </div>

                    <!-- Restricted access indicators for regular admins -->
                    <div id="restrictedControls" style="display: none;">
                        <div class="restricted-control d-inline-block">
                            <button class="control-button btn btn-success" disabled>
                                <i class="fas fa-play me-2"></i>
                                Sensor ON
                            </button>
                            <div class="access-denied-tooltip">Super Admin Only</div>
                        </div>
                        <div class="restricted-control d-inline-block">
                            <button class="control-button btn btn-secondary" disabled>
                                <i class="fas fa-stop me-2"></i>
                                Sensor OFF
                            </button>
                            <div class="access-denied-tooltip">Super Admin Only</div>
                        </div>
                        <div class="restricted-control d-inline-block">
                            <button class="control-button btn btn-warning" disabled>
                                <i class="fas fa-volume-up me-2"></i>
                                Toggle Siren
                            </button>
                            <div class="access-denied-tooltip">Super Admin Only</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Calendar -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Activity Calendar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="calendar">
                            <!-- Calendar will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <div class="mt-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h6 class="mb-0">
                        <i class="fas fa-bug me-2"></i>
                        Debug Log
                    </h6>
                </div>
                <div class="card-body">
                    <div id="debugLog" class="bg-dark text-light p-3 rounded" style="height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8rem;">
                        System initialized...<br>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global state management
        let isInitialized = false;
        let currentUserRole = 'admin'; // Will be updated on authentication
        let notificationPermission = 'default';
        let MQTT_CONFIG = {
            host: '',
            port: '',
            clientId: 'sinchan_web_' + Math.random().toString(16).substr(2, 8),
            username: '',
            password: '',
            topics: {
                sensor: 'sinchan/sensor/status',
                motion: 'sinchan/sensor/motion',
                sirene: 'sinchan/sirene/status',
                camera: 'sinchan/camera/capture',
                activate: 'sinchan/sirene/activate',
                database: 'sinchan/camera/database'
            }
        };

        let mqttClient = null;
        let activityDates = [];
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // ====== DESKTOP NOTIFICATION SYSTEM ======
        
        // Check and initialize notification permission
        function checkNotificationSupport() {
            if (!("Notification" in window)) {
                debugLog("This browser does not support desktop notifications");
                return false;
            }
            
            notificationPermission = Notification.permission;
            updateNotificationUI();
            
            // Show notification panel if permission is default (not granted/denied)
            if (notificationPermission === 'default') {
                showNotificationPanel();
            }
            
            debugLog(`Notification permission: ${notificationPermission}`);
            return true;
        }

        // Request notification permission
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("Browser tidak mendukung desktop notifications");
                return;
            }

            if (Notification.permission === 'granted') {
                showDesktopNotification('Notifications Enabled!', 'You will now receive desktop notifications from Sinchan Security System', 'success');
                hideNotificationPanel();
                return;
            }

            if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(function(permission) {
                    notificationPermission = permission;
                    updateNotificationUI();
                    
                    if (permission === 'granted') {
                        showDesktopNotification(
                            'Notifications Enabled!', 
                            'You will now receive desktop notifications from Sinchan Security System',
                            'success'
                        );
                        hideNotificationPanel();
                        debugLog('Desktop notifications enabled successfully');
                    } else if (permission === 'denied') {
                        alert('Notifications have been blocked. Please enable them in your browser settings to receive alerts.');
                        debugLog('Desktop notifications denied by user');
                    }
                });
            } else {
                alert('Notifications are blocked. Please enable them in your browser settings.');
                debugLog('Desktop notifications are blocked');
            }
        }

        // Show desktop notification
        function showDesktopNotification(title, body, type = 'info', actions = []) {
            // Also show in-page notification
            showAlert(body, getNotificationTypeClass(type), getNotificationIcon(type));
            
            // Check if desktop notifications are supported and allowed
            if (!("Notification" in window) || Notification.permission !== 'granted') {
                debugLog('Desktop notification not shown - permission not granted');
                return;
            }

            try {
                const options = {
                    body: body,
                    icon: getNotificationIconUrl(type),
                    badge: '/favicon.ico', // You can add your own badge icon
                    // tag: `sinchan-${type}-${Date.now()}`, // Unique tag to prevent duplicate notifications
                    requireInteraction: false,
                    silent: false,
                    timestamp: Date.now(),
                    data: {
                        type: type,
                        timestamp: new Date().toISOString()
                    }
                };

                // Add vibration for mobile devices
                if ('vibrate' in navigator && (type === 'danger' || type === 'warning')) {
                    navigator.vibrate([200, 100, 200]);
                }

                const notification = new Notification(title, options);
                
                // Auto-close notification after specified time (except for critical ones)
                if (type !== 'critical' && type !== 'danger') {
                    setTimeout(() => {
                        notification.close();
                    }, type === 'warning' ? 8000 : 5000);
                }

                // Handle notification click
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus(); // Focus the browser window
                    notification.close();
                    
                    // Optional: Navigate to specific section based on notification type
                    if (type === 'motion' || type === 'danger') {
                        // Could scroll to sensor status or open gallery
                        document.getElementById('sensorStatus').scrollIntoView({ behavior: 'smooth' });
                    }
                };

                debugLog(`Desktop notification sent: ${title} - ${body}`);
                
            // console.log('[Notification]', title, body); // Tambahkan ini untuk debug
            
            // if (!("Notification" in window) || Notification.permission !== 'granted') {
            //     console.warn("Notification not sent - permission denied or unsupported");
            //     return;
            // }
            
            } catch (error) {
                debugLog(`Failed to show desktop notification: ${error.message}`);
            }
        }

        // Get notification type class for in-page alerts
        function getNotificationTypeClass(type) {
            const typeMap = {
                'success': 'success',
                'danger': 'danger',
                'warning': 'warning',
                'info': 'info',
                'motion': 'warning',
                'critical': 'danger',
                'sirene': 'danger'
            };
            return typeMap[type] || 'info';
        }

        // Get notification icon
        function getNotificationIcon(type) {
            const iconMap = {
                'success': 'fa-check-circle',
                'danger': 'fa-exclamation-triangle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle',
                'motion': 'fa-running',
                'critical': 'fa-exclamation-triangle',
                'sirene': 'fa-bullhorn'
            };
            return iconMap[type] || 'fa-info-circle';
        }

        // Get notification icon URL for desktop notifications
        function getNotificationIconUrl(type) {
            // Simple colored circle icons for different notification types
            const iconMap = {
                'success': 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%2316a34a"/><path d="M20 32l8 8 16-16" stroke="white" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                'danger': 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%23dc2626"/><path d="M32 16v16M32 40h0" stroke="white" stroke-width="4" stroke-linecap="round"/></svg>',
                'warning': 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%23d97706"/><path d="M32 16v16M32 40h0" stroke="white" stroke-width="4" stroke-linecap="round"/></svg>',
                'info': 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%230891b2"/><path d="M32 24v16M32 16h0" stroke="white" stroke-width="4" stroke-linecap="round"/></svg>',
                'motion': 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%23d97706"/><path d="M20 32h24M36 24l8 8-8 8" stroke="white" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                'critical': 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%23dc2626"/><path d="M32 16v16M32 40h0" stroke="white" stroke-width="6" stroke-linecap="round"/></svg>',
                'sirene': 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%23dc2626"/><path d="M24 28h16v8H24z M20 24h24v4H20z M20 40h24v4H20z" fill="white"/></svg>'
            };
            return iconMap[type] || iconMap['info'];
        }

        // Update notification UI elements
        function updateNotificationUI() {
            const statusElement = document.getElementById('notificationStatus');
            const enableBtn = document.getElementById('enableNotificationsBtn');
            
            if (!statusElement || !enableBtn) return;
            
            switch (notificationPermission) {
                case 'granted':
                    statusElement.textContent = 'Enabled';
                    statusElement.className = 'notification-status notification-granted';
                    enableBtn.innerHTML = '<i class="fas fa-check me-1"></i>Enabled';
                    enableBtn.disabled = true;
                    enableBtn.className = 'btn btn-success btn-sm';
                    break;
                case 'denied':
                    statusElement.textContent = 'Blocked';
                    statusElement.className = 'notification-status notification-denied';
                    enableBtn.innerHTML = '<i class="fas fa-times me-1"></i>Blocked';
                    enableBtn.disabled = true;
                    enableBtn.className = 'btn btn-danger btn-sm';
                    break;
                default:
                    statusElement.textContent = 'Not Enabled';
                    statusElement.className = 'notification-status notification-default';
                    enableBtn.innerHTML = '<i class="fas fa-bell me-1"></i>Enable Notifications';
                    enableBtn.disabled = false;
                    enableBtn.className = 'btn btn-warning btn-sm';
            }
        }

        // Show notification permission panel
        function showNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            if (panel) {
                panel.classList.add('show');
            }
        }

        // Hide notification permission panel
        function hideNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            if (panel) {
                panel.classList.remove('show');
            }
        }

        // Test desktop notification
        function testDesktopNotification() {
            showDesktopNotification(
                'Test Notification',
                'This is a test notification from Sinchan Security System',
                'info'
            );
        }

        // Enhanced notification functions for different events
        function notifyMotionDetected() {
            showDesktopNotification(
                'ðŸš¨ MOTION DETECTED!',
                'PIR sensor detected movement. Security sequence initiated.',
                'motion'
            );
        }

        function notifyImageCaptured(captureType = 'manual') {
            const typeText = captureType === 'manual' ? 'Manual Capture' : 
                           captureType === 'motion' ? 'Motion Detection' : 'Capture';
            
            showDesktopNotification(
                'ðŸ“· Image Captured',
                `${typeText} - Image saved to database successfully.`,
                'success'
            );
        }

        function notifySireneActivated(status) {
            const isActive = status === 'sireneOn' || status === 'active' || status === '1';
            showDesktopNotification(
                isActive ? 'ðŸ”Š SIREN ACTIVATED!' : 'ðŸ”‡ Siren Deactivated',
                isActive ? 'Security siren is now active' : 'Security siren has been turned off',
                isActive ? 'danger' : 'info'
            );
        }

        function notifySequenceStarted() {
            showDesktopNotification(
                'âš ï¸ SECURITY SEQUENCE ACTIVE',
                'Motion sequence started: 2 images â†’ siren â†’ 8 images â†’ siren',
                'warning'
            );
        }

        function notifySequenceCompleted() {
            showDesktopNotification(
                'âœ… Security Sequence Complete',
                'Motion detection sequence finished. PIR sensor re-enabled.',
                'success'
            );
        }

        function notifyConnectionStatus(isOnline) {
            if (isOnline) {
                showDesktopNotification(
                    'ðŸ”— MQTT Connected',
                    'Successfully connected to security system',
                    'success'
                );
            } else {
                showDesktopNotification(
                    'âš ï¸ Connection Lost',
                    'Lost connection to security system. Attempting to reconnect...',
                    'warning'
                );
            }
        }

        function notifyCriticalAlert(message) {
            showDesktopNotification(
                'ðŸš¨ CRITICAL ALERT',
                message,
                'critical'
            );
        }

        // ====== END DESKTOP NOTIFICATION SYSTEM ======

        // Enhanced Authentication Check with Role-Based Access Control
        function checkAuthentication() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const userRole = sessionStorage.getItem('userRole');
            const username = sessionStorage.getItem('username');
            const fullName = sessionStorage.getItem('fullName');

            // Check if user is logged in
            if (isLoggedIn !== 'true') {
                window.location.replace("login.html");
                return false;
            }

            // Update current user role
            currentUserRole = userRole;

            // For admin users, verify they still exist and are active
            if (userRole === 'admin') {
                const adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '{}');
                const currentUser = adminUsers[username];
                
                if (!currentUser || !currentUser.active) {
                    alert('Your account has been deactivated. Please contact the administrator.');
                    sessionStorage.clear();
                    window.location.replace("login.html");
                    return false;
                }
            }

            // Update UI with user information
            document.getElementById('currentUserName').textContent = fullName || username || 'User';
            document.getElementById('userRole').textContent = userRole === 'superadmin' ? 'Super Admin' : 'Admin';

            // Configure role-based access
            configureRoleBasedAccess(userRole);

            return true;
        }

        // Configure access based on user role
        function configureRoleBasedAccess(userRole) {
            const superAdminControls = document.getElementById('superAdminControls');
            const restrictedControls = document.getElementById('restrictedControls');
            const adminPanelBtn = document.getElementById('adminPanelBtn');

            if (userRole === 'superadmin') {
                // Super Admin: Show all controls and admin panel button
                superAdminControls.style.display = 'block';
                restrictedControls.style.display = 'none';
                adminPanelBtn.style.display = 'inline-block';
                
                debugLog('Super Admin access granted - Full system control enabled');
            } else {
                // Regular Admin: Hide sensitive controls, show restricted indicators
                superAdminControls.style.display = 'none';
                restrictedControls.style.display = 'block';
                adminPanelBtn.style.display = 'none';
                
                debugLog('Regular Admin access - Restricted control mode enabled');
            }
        }

        // Check if returning from another page
        function checkNavigationState() {
            const navigatingFrom = sessionStorage.getItem('navigatingFromPage');
            const skipInit = sessionStorage.getItem('skipInitialization');
            
            if (navigatingFrom && skipInit === 'true') {
                debugLog(`Returning from ${navigatingFrom}, restoring state...`);
                showLoadingOverlay(true);
                
                // Restore complete state
                restoreCompletePageState();
                
                // Clear navigation flags
                sessionStorage.removeItem('navigatingFromPage');
                sessionStorage.removeItem('skipInitialization');
                
                setTimeout(() => {
                    showLoadingOverlay(false);
                    debugLog('State restored successfully');
                }, 1000);
                
                return true; // Skip normal initialization
            }
            return false; // Proceed with normal initialization
        }

        function showLoadingOverlay(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // Session Management - Check login status
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            if (!checkAuthentication()) {
                return;
            }
            
            // Initialize notification system
            checkNotificationSupport();
            
            // Check if returning from navigation
            if (checkNavigationState()) {
                return; // Skip normal initialization
            }
            
            // Normal initialization
            initializeHomepage();
        });

        // Handle page visibility changes (back button, etc)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isInitialized) {
                // Page became visible again, check if we need to restore state
                const shouldRestore = sessionStorage.getItem('homepageNeedsRestore');
                if (shouldRestore === 'true') {
                    debugLog('Page visible again, restoring state...');
                    restoreCompletePageState();
                    sessionStorage.removeItem('homepageNeedsRestore');
                }
            }
        });

        function initializeHomepage() {
            if (isInitialized) return;
            
            debugLog('Initializing homepage...');
            loadActivityDates();
            generateCalendar();
            restorePageState();
            
            // Initialize sirene status tracking without notification
            const sireneEl = document.getElementById('sireneStatus');
            sireneEl.setAttribute('data-sirene-status', 'unknown'); // Use 'unknown' to allow first notification
            sireneEl.setAttribute('data-last-notification', '0');
            
            // Setup role-based event listeners
            setupControlEventListeners();
            
            // Auto-connect MQTT
            setTimeout(connectMQTT, 1000);
            
            isInitialized = true;
            debugLog('Homepage initialization complete');
        }

        // Setup control event listeners based on user role
        function setupControlEventListeners() {
            // Always available: Capture button
            document.getElementById('btnCapture').addEventListener('click', function() {
                // Mark this as manual capture to prevent siren activation
                sessionStorage.setItem('manualCapture', 'true');
                sessionStorage.setItem('manualCaptureTime', Date.now().toString());
                
                publishMessage(MQTT_CONFIG.topics.camera, 'capture', 2);
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Capturing...';
                
                // Show processing message only
                debugLog('Manual capture initiated - waiting for database confirmation');
                
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-camera me-2"></i>Capture Image';
                }, 2000);
            });

            // Super Admin only controls
            if (currentUserRole === 'superadmin') {
                const btnSensorOn = document.getElementById('btnSensorOn');
                const btnSensorOff = document.getElementById('btnSensorOff');
                const btnSireneToggle = document.getElementById('btnSireneToggle');

                if (btnSensorOn) {
                    btnSensorOn.addEventListener('click', function() {
                        publishMessage(MQTT_CONFIG.topics.sensor, 'sensorOn', 2);
                        debugLog('Sensor ON command sent (Super Admin)');
                    });
                }

                if (btnSensorOff) {
                    btnSensorOff.addEventListener('click', function() {
                        publishMessage(MQTT_CONFIG.topics.sensor, 'sensorOff', 2);
                        debugLog('Sensor OFF command sent (Super Admin)');
                    });
                }

                if (btnSireneToggle) {
                    btnSireneToggle.addEventListener('click', function() {
                        const currentStatus = document.getElementById('sireneText').textContent;
                        const newStatus = currentStatus === 'ACTIVE' ? '0' : '1';
                        
                        publishMessage(MQTT_CONFIG.topics.activate, newStatus, 2);
                        debugLog(`Sirene toggle command sent: ${newStatus} (Super Admin)`);
                    });
                }
            } else {
                // For regular admins, show access denied messages when they try to interact
                debugLog('Sensor and sirene controls restricted for regular admin');
            }
        }

        function restoreCompletePageState() {
            // Restore MQTT configuration
            const savedMqttHost = sessionStorage.getItem('homepageMqttHost');
            const savedMqttPort = sessionStorage.getItem('homepageMqttPort');
            const savedMqttUsername = sessionStorage.getItem('homepageMqttUsername');
            const savedConnectionStatus = sessionStorage.getItem('homepageConnectionStatus');
            const savedLastUpdate = sessionStorage.getItem('homepageLastUpdate');
            const savedDebugLog = sessionStorage.getItem('homepageDebugLog');
            const savedSensorStatus = sessionStorage.getItem('homepageSensorStatus');
            const savedSireneStatus = sessionStorage.getItem('homepageSireneStatus');
            
            if (savedMqttHost) document.getElementById('mqttHost').value = savedMqttHost;
            if (savedMqttPort) document.getElementById('mqttPort').value = savedMqttPort;
            if (savedMqttUsername) document.getElementById('mqttUsername').value = savedMqttUsername;
            
            // Restore connection status
            if (savedConnectionStatus) {
                const statusEl = document.getElementById('connectionStatus');
                const statusText = statusEl.querySelector('span');
                if (savedConnectionStatus === 'online') {
                    statusEl.className = 'connection-status connection-online';
                    statusText.textContent = 'Online';
                } else {
                    statusEl.className = 'connection-status connection-offline';
                    statusText.textContent = 'Offline';
                }
            }
            
            // Restore last update
            if (savedLastUpdate) {
                document.getElementById('lastUpdate').textContent = savedLastUpdate;
            }
            
            // Restore debug log
            if (savedDebugLog) {
                document.getElementById('debugLog').innerHTML = savedDebugLog;
            }
            
            // Restore sensor status
            if (savedSensorStatus) {
                const statusData = JSON.parse(savedSensorStatus);
                const sensorEl = document.getElementById('sensorStatus');
                const sensorText = document.getElementById('sensorText');
                sensorEl.className = statusData.className;
                sensorText.textContent = statusData.text;
            }
            
            // Restore sirene status
            if (savedSireneStatus) {
                const statusData = JSON.parse(savedSireneStatus);
                const sireneEl = document.getElementById('sireneStatus');
                const sireneText = document.getElementById('sireneText');
                sireneEl.className = statusData.className;
                sireneText.textContent = statusData.text;
            }
            
            // Restore activity dates and calendar
            const savedActivityDates = sessionStorage.getItem('homepageActivityDates');
            if (savedActivityDates) {
                activityDates = JSON.parse(savedActivityDates);
                updateCalendar();
            }
            
            // Reconnect MQTT if it was connected
            if (savedConnectionStatus === 'online') {
                setTimeout(() => {
                    debugLog('Attempting to reconnect MQTT...');
                    connectMQTT();
                }, 1500);
            }
        }

        function restorePageState() {
            // Restore MQTT configuration from sessionStorage
            const savedMqttHost = sessionStorage.getItem('homepageMqttHost');
            const savedMqttPort = sessionStorage.getItem('homepageMqttPort');
            const savedMqttUsername = sessionStorage.getItem('homepageMqttUsername');
            
            if (savedMqttHost) document.getElementById('mqttHost').value = savedMqttHost;
            if (savedMqttPort) document.getElementById('mqttPort').value = savedMqttPort;
            if (savedMqttUsername) document.getElementById('mqttUsername').value = savedMqttUsername;
            
            // Restore activity dates
            const savedActivityDates = sessionStorage.getItem('homepageActivityDates');
            if (savedActivityDates) {
                activityDates = JSON.parse(savedActivityDates);
                updateCalendar();
            }
        }

        function saveCompletePageState() {
            // Save MQTT configuration
            sessionStorage.setItem('homepageMqttHost', document.getElementById('mqttHost').value);
            sessionStorage.setItem('homepageMqttPort', document.getElementById('mqttPort').value);
            sessionStorage.setItem('homepageMqttUsername', document.getElementById('mqttUsername').value);
            
            // Save connection status
            const statusEl = document.getElementById('connectionStatus');
            const isOnline = statusEl.classList.contains('connection-online');
            sessionStorage.setItem('homepageConnectionStatus', isOnline ? 'online' : 'offline');
            
            // Save last update
            sessionStorage.setItem('homepageLastUpdate', document.getElementById('lastUpdate').textContent);
            
            // Save debug log
            sessionStorage.setItem('homepageDebugLog', document.getElementById('debugLog').innerHTML);
            
            // Save sensor status
            const sensorEl = document.getElementById('sensorStatus');
            const sensorText = document.getElementById('sensorText');
            sessionStorage.setItem('homepageSensorStatus', JSON.stringify({
                className: sensorEl.className,
                text: sensorText.textContent
            }));
            
            // Save sirene status
            const sireneEl = document.getElementById('sireneStatus');
            const sireneText = document.getElementById('sireneText');
            sessionStorage.setItem('homepageSireneStatus', JSON.stringify({
                className: sireneEl.className,
                text: sireneText.textContent
            }));
            
            // Save activity dates
            sessionStorage.setItem('homepageActivityDates', JSON.stringify(activityDates));
        }

        function navigateToGallery() {
            debugLog('Navigating to gallery, saving state...');
            
            // Save complete current state
            saveCompletePageState();
            
            // Set navigation flags
            sessionStorage.setItem('navigatingFromPage', 'homepage');
            sessionStorage.setItem('skipInitialization', 'true');
            
            // Navigate
            window.location.href = "captured.html";
        }

        function navigateToAdminPanel() {
            const userRole = sessionStorage.getItem('userRole');
            
            if (userRole !== 'superadmin') {
                alert('Access denied. Super Admin privileges required.');
                debugLog('Admin panel access denied - insufficient privileges');
                return;
            }

            debugLog('Navigating to admin panel, saving state...');
            
            // Save complete current state
            saveCompletePageState();
            
            // Set navigation flags
            sessionStorage.setItem('navigatingFromPage', 'homepage');
            sessionStorage.setItem('skipInitialization', 'true');
            
            // Navigate
            window.location.href = "admin-panel.html";
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                debugLog(`User ${currentUserRole} logging out`);
                // Clear all session data
                sessionStorage.clear();
                window.location.replace("login.html");
            }
        }

        // ====== ALERT NOTIFICATION SYSTEM ======
        function showAlert(html) {
            const container = document.getElementById('debugLog');
            container.innerHTML += html;
            container.scrollTop = container.scrollHeight;
        }

        function notifyDoorOpened() {
            showAlert(`
                <div class="alert d-flex bg-warning-l2 brc-warning-m3 border-2 radius-1 py-2 px-3 mb-2">
                <i class="fas fa-door-open fa-lg text-warning me-3 mt-1"></i>
                <div>
                    <strong class="text-dark-tp3">Pintu Terbuka!</strong><br />
                    Deteksi gerakan oleh sensor PIR.<br />
                    <small class="text-grey-m2"><i class="far fa-clock"></i> ${new Date().toLocaleTimeString()}</small>
                </div>
                </div>
            `);

            // Send desktop notification
            notifyMotionDetected();
        }

        // Debug logging with role information
        function debugLog(message) {
            const logEl = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const rolePrefix = currentUserRole === 'superadmin' ? '[SUPER]' : '[ADMIN]';
            logEl.innerHTML += `[${timestamp}] ${rolePrefix} ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`${rolePrefix} ${message}`);
        }

        // Update MQTT config from form
        function updateMQTTConfig() {
            MQTT_CONFIG.useSSL = true;
            MQTT_CONFIG.host = document.getElementById('mqttHost').value || '50d16c3705494389a2649a641024f95c.s1.eu.hivemq.cloud';
            MQTT_CONFIG.port = parseInt(document.getElementById('mqttPort').value) || 8884;
            MQTT_CONFIG.username = document.getElementById('mqttUsername').value;
            MQTT_CONFIG.password = document.getElementById('mqttPassword').value;
            MQTT_CONFIG.clientId = 'sinchan_web_' + Math.random().toString(16).substr(2, 8);
            MQTT_CONFIG.path = '/mqtt';
        }

        function showAlert(message, type = 'info', icon = 'fa-info-circle') {
            const toastContainer = document.getElementById('toastContainer');
            const timestamp = new Date().toLocaleTimeString();

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.style.minWidth = '300px';

            // Custom colors for sirene notifications
            if (type === 'danger') {
                toast.style.backgroundColor = '#dc2626';
                toast.style.color = 'white';
            } else if (type === 'secondary') {
                toast.style.backgroundColor = '#6b7280';
                toast.style.color = 'white';
            }

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas ${icon} me-2"></i>
                        ${message}
                        <div class="small text-muted">${timestamp}</div>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        // Initialize MQTT Connection
        function connectMQTT() {
            updateMQTTConfig();
            
            try {
                if (mqttClient && mqttClient.isConnected()) {
                    mqttClient.disconnect();
                    debugLog('Disconnected from previous MQTT session');
                }

                debugLog(`Attempting to connect to ${MQTT_CONFIG.host}:${MQTT_CONFIG.port}`);
                
                mqttClient = new Paho.MQTT.Client(MQTT_CONFIG.host, MQTT_CONFIG.port, MQTT_CONFIG.path, MQTT_CONFIG.clientId);
                
                mqttClient.onConnectionLost = onConnectionLost;
                mqttClient.onMessageArrived = onMessageArrived;

                const options = {
                    onSuccess: onConnect,
                    onFailure: onConnectFailure,
                    keepAliveInterval: 30,
                    cleanSession: true,
                    useSSL: true,
                    timeout: 10
                };

                // Add credentials if provided
                if (MQTT_CONFIG.username) {
                    options.userName = MQTT_CONFIG.username;
                    options.password = MQTT_CONFIG.password;
                }

                mqttClient.connect(options);
                
                // Update button state
                document.getElementById('btnConnect').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Connecting...';
                document.getElementById('btnConnect').disabled = true;
                
            } catch (error) {
                debugLog('MQTT initialization error: ' + error.message);
                updateConnectionStatus(false);
            }
        }

        function onConnect() {
            debugLog('MQTT Connected successfully');
            updateConnectionStatus(true);
            reconnectAttempts = 0;
            
            // Send desktop notification for connection
            notifyConnectionStatus(true);
            
            // Update button state
            document.getElementById('btnConnect').innerHTML = '<i class="fas fa-check me-1"></i>Connected';
            document.getElementById('btnConnect').disabled = false;
            
            // Subscribe to topics
            Object.values(MQTT_CONFIG.topics).forEach(topic => {
                try {
                    mqttClient.subscribe(topic, {qos: 2});
                    debugLog('Subscribed to: ' + topic);
                } catch (error) {
                    debugLog('Failed to subscribe to ' + topic + ': ' + error.message);
                }
            });
        }

        function onConnectFailure(error) {
            debugLog('MQTT Connection failed: ' + error.errorMessage);
            updateConnectionStatus(false);
            
            // Send desktop notification for connection failure
            if (reconnectAttempts === 0) { // Only notify on first failure
                notifyConnectionStatus(false);
            }
            
            // Update button state
            document.getElementById('btnConnect').innerHTML = '<i class="fas fa-plug me-1"></i>Connect';
            document.getElementById('btnConnect').disabled = false;
            
            // Auto-reconnect with exponential backoff
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                debugLog(`Reconnecting in ${delay/1000} seconds... (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(connectMQTT, delay);
            } else {
                debugLog('Max reconnection attempts reached. Please check your configuration.');
                notifyCriticalAlert('Max reconnection attempts reached. Please check MQTT configuration.');
            }
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                debugLog('MQTT Connection lost: ' + responseObject.errorMessage);
                updateConnectionStatus(false);
                
                // Send desktop notification
                notifyConnectionStatus(false);
                
                // Update button state
                document.getElementById('btnConnect').innerHTML = '<i class="fas fa-plug me-1"></i>Connect';
                document.getElementById('btnConnect').disabled = false;
                
                // Attempt to reconnect
                setTimeout(connectMQTT, 5000);
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            
            debugLog(`Message received: ${topic} = ${payload}`);
            updateLastUpdate();

            switch (topic) {
                case MQTT_CONFIG.topics.sensor:
                    updateSensorStatus(payload);
                    break;
                case MQTT_CONFIG.topics.motion:
                    handleMotionDetection(payload);
                    notifyDoorOpened();
                    break;
                case MQTT_CONFIG.topics.sirene:
                    updateSireneStatus(payload);
                    break;
                case MQTT_CONFIG.topics.camera:
                    // Manual capture - no immediate notification, wait for database confirmation
                    debugLog('Manual capture triggered');
                    break;
                case MQTT_CONFIG.topics.database:
                    // Check if this image is from motion detection or manual capture
                    handleImageReceived();
                    break;
            }
        }

        function updateConnectionStatus(isOnline) {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = statusEl.querySelector('span');
            
            if (isOnline) {
                statusEl.className = 'connection-status connection-online';
                statusText.textContent = 'Online';
            } else {
                statusEl.className = 'connection-status connection-offline';
                statusText.textContent = 'Offline';
            }
        }

        function updateSensorStatus(status) {
            const sensorEl = document.getElementById('sensorStatus');
            const sensorText = document.getElementById('sensorText');
            
            // Store previous status to detect changes
            const previousStatus = sensorEl.getAttribute('data-status') || '';
            sensorEl.setAttribute('data-status', status);

            sensorEl.className = 'status-card p-4 h-100';
            
            if (status === 'active' || status === '1' || status === 'on') {
                sensorEl.classList.add('sensor-active');
                sensorText.textContent = 'ACTIVE';
                
                // If coming from sequence_active, sequence is complete
                if (previousStatus === 'sequence_active') {
                    debugLog('Motion detection sequence completed');
                    notifySequenceCompleted();
                    showAlert('Motion sequence completed - PIR detection re-enabled', 'success', 'fa-check-circle');
                    // Clear motion flags after sequence completes
                    sessionStorage.removeItem('motionDetected');
                    sessionStorage.removeItem('motionDetectedTime');
                }
            } else if (status === 'sequence_active') {
                sensorEl.classList.add('sensor-sequence');
                sensorText.textContent = 'SEQUENCE RUNNING';
                debugLog('Motion sequence in progress - PIR detection blocked');
                showAlert('PIR detection blocked during sequence', 'info', 'fa-lock');
            } else {
                sensorEl.classList.add('sensor-inactive');
                sensorText.textContent = 'INACTIVE';
            }
        }

        function handleMotionDetection(status) {    
            if (status === 'detected' || status === '1' || status === 'true') {
                debugLog('Motion detection signal received!');
                notifySequenceStarted();
                showAlert('MOTION SEQUENCE: 2 images â†’ sirene â†’ 8 images â†’ sirene', 'warning', 'fa-exclamation-triangle');

                // Mark that motion was detected - this will be used for folder creation
                sessionStorage.setItem('motionDetected', 'true');
                sessionStorage.setItem('motionDetectedTime', Date.now().toString());
                
                // Signal captured page to create new folder if it's open
                sessionStorage.setItem('createNewFolder', 'true');

                // Add current date to activity dates
                const today = new Date().toISOString().split('T')[0];
                if (!activityDates.includes(today)) {
                    activityDates.push(today);
                    updateCalendar();
                    saveActivityDates();
                }

                // Note: Sensor status will be updated by RPi via MQTT to 'sequence_active'
                // No need to manually change sensor status here
            }
        }

        function handleImageReceived() {
            // Check if this image is from recent motion detection
            const motionDetected = sessionStorage.getItem('motionDetected');
            const motionTime = sessionStorage.getItem('motionDetectedTime');
            
            // Check if this image is from manual capture
            const manualCapture = sessionStorage.getItem('manualCapture');
            const manualCaptureTime = sessionStorage.getItem('manualCaptureTime');
            
            const currentTime = Date.now();
            
            // Extended time window for motion detection (60 seconds to cover full sequence)
            const isMotionTriggered = motionDetected === 'true' && motionTime && 
                                    (currentTime - parseInt(motionTime)) < 60000;
                                    
            // If manual capture was initiated within last 15 seconds
            const isManualCapture = manualCapture === 'true' && manualCaptureTime &&
                                   (currentTime - parseInt(manualCaptureTime)) < 15000;
            
            if (isManualCapture) {
                // This image is from manual capture - no siren, clear manual flag
                debugLog('Image from manual capture - no siren activation');
                notifyImageCaptured('manual');
                sessionStorage.removeItem('manualCapture');
                sessionStorage.removeItem('manualCaptureTime');
            } else if (isMotionTriggered) {
                // This image is from motion detection sequence - siren handled by RPi
                debugLog('Image from motion detection sequence - siren controlled by RPi');
                notifyImageCaptured('motion');
                // Don't clear motion flag here as multiple images will come in
            } else {
                // Unknown source - default to no siren for safety
                debugLog('Image from unknown source - no siren activation');
                notifyImageCaptured();
            }
        }

        function updateSireneStatus(status) {
            const sireneEl = document.getElementById('sireneStatus');
            const sireneText = document.getElementById('sireneText');
            const currentTime = Date.now();
            const lastNotificationTime = parseInt(sireneEl.getAttribute('data-last-notification') || '0');

            sireneEl.className = 'status-card p-4 h-100';
            
            if (status === 'active' || status === '1' || status === 'sireneOn') {
                sireneEl.classList.add('sirene-active');
                sireneText.textContent = 'ACTIVE';
                
                // Show notification if status actually changed and not too recent (prevent spam)
                const previousStatus = sireneEl.getAttribute('data-sirene-status');
                if (previousStatus !== 'active' && (currentTime - lastNotificationTime) > 1500) {
                    showAlert('Sirene AKTIF', 'danger', 'fa-bullhorn');
                    notifySireneActivated('sireneOn');
                    sireneEl.setAttribute('data-last-notification', currentTime.toString());
                }
                sireneEl.setAttribute('data-sirene-status', 'active');
            } else {
                sireneEl.classList.add('sirene-inactive');
                sireneText.textContent = 'INACTIVE';
                
                // Show notification if status actually changed and not too recent (prevent spam)
                const previousStatus = sireneEl.getAttribute('data-sirene-status');
                if (previousStatus === 'active' && (currentTime - lastNotificationTime) > 1500) {
                    showAlert('Sirene NONAKTIF', 'secondary', 'fa-volume-mute');
                    notifySireneActivated('sireneOff');
                    sireneEl.setAttribute('data-last-notification', currentTime.toString());
                }
                sireneEl.setAttribute('data-sirene-status', 'inactive');
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = `Last update: ${timeString}`;
        }

        // Control Functions with Role-Based Restrictions
        function publishMessage(topic, message, qosLevel = 2) {
            if (mqttClient && mqttClient.isConnected()) {
                try {
                    const mqttMessage = new Paho.MQTT.Message(message);
                    mqttMessage.destinationName = topic;
                    mqttMessage.qos = qosLevel;
                    mqttClient.send(mqttMessage);
                    debugLog(`Message sent: ${topic} = ${message} (QoS ${qosLevel})`);
                } catch (error) {
                    debugLog('Failed to send message: ' + error.message);
                }
            } else {
                debugLog('MQTT not connected. Cannot send message.');
                alert('MQTT not connected. Please check your connection.');
            }
        }

        // Calendar Functions
        function generateCalendar() {
            const calendarEl = document.getElementById('calendar');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            let calendarHTML = `
                <div class="text-center mb-3">
                    <h4>${monthNames[currentMonth]} ${currentYear}</h4>
                </div>
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Sun</th>
                            <th class="text-center">Mon</th>
                            <th class="text-center">Tue</th>
                            <th class="text-center">Wed</th>
                            <th class="text-center">Thu</th>
                            <th class="text-center">Fri</th>
                            <th class="text-center">Sat</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let date = 1;
            for (let i = 0; i < 6; i++) {
                calendarHTML += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        calendarHTML += '<td class="text-center p-3"></td>';
                    } else if (date > daysInMonth) {
                        calendarHTML += '<td class="text-center p-3"></td>';
                    } else {
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        const hasActivity = activityDates.includes(dateStr);
                        const isToday = date === now.getDate();
                        
                        let cellClass = 'text-center p-3';
                        if (hasActivity) cellClass += ' calendar-has-activity';
                        if (isToday && !hasActivity) cellClass += ' bg-info text-white';
                        
                        const clickHandler = hasActivity ? `onclick="viewActivityDate('${dateStr}')"` : '';
                        
                        calendarHTML += `<td class="${cellClass}" ${clickHandler}>
                            <div>${date}</div>
                        </td>`;
                        date++;
                    }
                }
                calendarHTML += '</tr>';
                if (date > daysInMonth) break;
            }
            
            calendarHTML += '</tbody></table>';
            calendarEl.innerHTML = calendarHTML;
        }

        function updateCalendar() {
            generateCalendar();
        }

        function viewActivityDate(dateStr) {
            alert(`Activity detected on ${dateStr}. Gallery feature coming soon!`);
        }

        function saveActivityDates() {
            localStorage.setItem('activityDates', JSON.stringify(activityDates));
            sessionStorage.setItem('homepageActivityDates', JSON.stringify(activityDates));
        }

        function loadActivityDates() {
            const saved = localStorage.getItem('activityDates') || sessionStorage.getItem('homepageActivityDates');
            if (saved) {
                activityDates = JSON.parse(saved);
            }
        }

        // Save state periodically and before unload
        setInterval(() => {
            if (isInitialized) {
                saveCompletePageState();
            }
        }, 10000); // Save every 10 seconds

        window.addEventListener('beforeunload', function() {
            if (isInitialized) {
                saveCompletePageState();
                sessionStorage.setItem('homepageNeedsRestore', 'true');
            }
        });

        // Security measures - prevent unauthorized access
        window.addEventListener('storage', function(e) {
            // If admin users are updated and current user is admin, recheck authentication
            if (e.key === 'adminUsers') {
                const userRole = sessionStorage.getItem('userRole');
                if (userRole === 'admin') {
                    checkAuthentication();
                }
            }
        });

        // Periodic authentication check for admin users
        setInterval(() => {
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'admin') {
                checkAuthentication();
            }
        }, 60000); // Check every minute

        // Access Control Functions
        function checkSuperAdminAccess(action) {
            if (currentUserRole !== 'superadmin') {
                debugLog(`Access denied: ${action} requires Super Admin privileges`);
                showAlert('Access denied. Super Admin privileges required.', 'danger', 'fa-lock');
                return false;
            }
            return true;
        }

        // Enhanced control functions with access control
        function activateSensor() {
            if (!checkSuperAdminAccess('Sensor activation')) return;
            publishMessage(MQTT_CONFIG.topics.sensor, 'sensorOn', 2);
            debugLog('Sensor activation command sent by Super Admin');
        }

        function deactivateSensor() {
            if (!checkSuperAdminAccess('Sensor deactivation')) return;
            publishMessage(MQTT_CONFIG.topics.sensor, 'sensorOff', 2);
            debugLog('Sensor deactivation command sent by Super Admin');
        }

        function toggleSiren() {
            if (!checkSuperAdminAccess('Siren control')) return;
            const currentStatus = document.getElementById('sireneText').textContent;
            const newStatus = currentStatus === 'ACTIVE' ? '0' : '1';
            publishMessage(MQTT_CONFIG.topics.activate, newStatus, 2);
            debugLog(`Siren toggle command sent by Super Admin: ${newStatus}`);
        }

        // Role-based UI updates
        function updateUIForRole() {
            const roleElement = document.getElementById('userRole');
            const userNameElement = document.getElementById('currentUserName');
            
            if (currentUserRole === 'superadmin') {
                roleElement.style.background = 'linear-gradient(135deg, #dc2626, #b91c1c)';
                roleElement.innerHTML = '<i class="fas fa-crown me-1"></i>Super Admin';
            } else {
                roleElement.style.background = 'var(--primary-color)';
                roleElement.innerHTML = '<i class="fas fa-user me-1"></i>Admin';
            }
            
            debugLog(`UI updated for ${currentUserRole} role`);
        }

        // Initialize role-based UI after authentication
        function initializeRoleBasedUI() {
            updateUIForRole();
            
            // Add role-specific styling
            if (currentUserRole === 'admin') {
                // Add subtle indicator for restricted access
                const restrictedElements = document.querySelectorAll('.restricted-control');
                restrictedElements.forEach(el => {
                    el.style.position = 'relative';
                });
            }
        }

        // Enhanced authentication with role-based initialization
        function enhancedCheckAuthentication() {
            if (!checkAuthentication()) return false;
            
            // Initialize role-based features
            initializeRoleBasedUI();
            
            return true;
        }

        // Security logging for access attempts
        function logSecurityEvent(event, details = '') {
            const timestamp = new Date().toISOString();
            const userInfo = `${sessionStorage.getItem('username')} (${currentUserRole})`;
            const logEntry = `[SECURITY] ${timestamp} - ${userInfo}: ${event} ${details}`;
            
            console.log(logEntry);
            debugLog(`Security Event: ${event} ${details}`);
            
            // In production, this should be sent to a security monitoring system
        }

        // Enhanced logout with security logging
        function secureLogout() {
            logSecurityEvent('User logout initiated');
            
            if (confirm('Are you sure you want to logout?')) {
                logSecurityEvent('User logout confirmed');
                debugLog(`User ${currentUserRole} logging out`);
                
                // Clear all session data
                sessionStorage.clear();
                
                // Clear any temporary MQTT connections
                if (mqttClient && mqttClient.isConnected()) {
                    try {
                        mqttClient.disconnect();
                        debugLog('MQTT connection closed on logout');
                    } catch (error) {
                        debugLog('Error closing MQTT connection: ' + error.message);
                    }
                }
                
                window.location.replace("login.html");
            } else {
                logSecurityEvent('User logout cancelled');
            }
        }

        // Override logout function
        function logout() {
            secureLogout();
        }

        // Add keyboard shortcuts for Super Admin (optional feature)
        document.addEventListener('keydown', function(e) {
            // Only for Super Admin and when Ctrl+Alt is pressed
            if (currentUserRole === 'superadmin' && e.ctrlKey && e.altKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        activateSensor();
                        break;
                    case '2':
                        e.preventDefault();
                        deactivateSensor();
                        break;
                    case '3':
                        e.preventDefault();
                        toggleSiren();
                        break;
                    case 'c':
                        e.preventDefault();
                        document.getElementById('btnCapture').click();
                        break;
                    case 't':
                        e.preventDefault();
                        testDesktopNotification();
                        break;
                }
            }
        });

        // Role-based help system
        function showHelp() {
            let helpMessage = `
                <div class="help-content">
                    <h5><i class="fas fa-question-circle me-2"></i>System Help</h5>
                    <div class="mb-3">
                        <h6>Available Features:</h6>
                        <ul>
                            <li><i class="fas fa-camera text-primary"></i> Image Capture - Take manual photos</li>
                            <li><i class="fas fa-images text-info"></i> Gallery - View captured images</li>
                            <li><i class="fas fa-calendar text-success"></i> Activity Calendar - Monitor activity dates</li>
                            <li><i class="fas fa-wifi text-warning"></i> MQTT Connection - Real-time communication</li>
                            <li><i class="fas fa-bell text-info"></i> Desktop Notifications - Alerts even when tab is inactive</li>
                        </ul>
                    </div>
            `;
            
            if (currentUserRole === 'superadmin') {
                helpMessage += `
                    <div class="mb-3">
                        <h6 class="text-danger">Super Admin Features:</h6>
                        <ul>
                            <li><i class="fas fa-play text-success"></i> Sensor Control - Enable/disable motion detection</li>
                            <li><i class="fas fa-volume-up text-warning"></i> Siren Control - Manual siren activation</li>
                            <li><i class="fas fa-user-shield text-primary"></i> Admin Panel - User management</li>
                        </ul>
                        <div class="small text-muted">
                            <strong>Keyboard Shortcuts:</strong> Ctrl+Alt+1 (Sensor On), Ctrl+Alt+2 (Sensor Off), Ctrl+Alt+3 (Toggle Siren), Ctrl+Alt+C (Capture), Ctrl+Alt+T (Test Notification)
                        </div>
                    </div>
                `;
            } else {
                helpMessage += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Sensor and siren controls require Super Admin privileges.
                        Contact your administrator for elevated access.
                    </div>
                `;
            }
            
            helpMessage += `
                    <div class="mb-3">
                        <h6>Desktop Notifications:</h6>
                        <p class="small">Enable desktop notifications to receive security alerts even when:</p>
                        <ul class="small">
                            <li>You're browsing other websites</li>
                            <li>You're using other applications</li>
                            <li>Your browser tab is minimized</li>
                            <li>Your screen is locked (depending on system settings)</li>
                        </ul>
                        <p class="small text-muted">
                            <strong>Privacy:</strong> Notifications are handled locally by your browser. No data is sent to external servers.
                        </p>
                    </div>
                </div>`;
            
            // Create and show help modal (you can implement this with Bootstrap modal)
            alert(helpMessage.replace(/<[^>]*>/g, '')); // Simple alert for now
        }

        // Add help button functionality
        function addHelpButton() {
            const headerDiv = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-4 .text-end');
            if (headerDiv) {
                const helpBtn = document.createElement('button');
                helpBtn.className = 'btn btn-outline-info btn-sm me-1';
                helpBtn.innerHTML = '<i class="fas fa-question-circle me-1"></i>Help';
                helpBtn.onclick = showHelp;
                
                // Insert before logout button
                const logoutBtn = headerDiv.querySelector('button[onclick="logout()"]');
                if (logoutBtn) {
                    headerDiv.insertBefore(helpBtn, logoutBtn);
                }
            }
        }

        // Initialize help button after page load
        setTimeout(addHelpButton, 1000);

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            debugLog(`JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`);
            logSecurityEvent('JavaScript error occurred', e.message);
        });

        // Connection monitoring
        let connectionCheckInterval;

        function startConnectionMonitoring() {
            connectionCheckInterval = setInterval(() => {
                if (mqttClient && mqttClient.isConnected()) {
                    // Connection is healthy
                    updateConnectionStatus(true);
                } else {
                    // Connection lost
                    updateConnectionStatus(false);
                    debugLog('Connection check failed - attempting reconnection');
                    connectMQTT();
                }
            }, 30000); // Check every 30 seconds
        }

        function stopConnectionMonitoring() {
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
                connectionCheckInterval = null;
            }
        }

        // Start monitoring after successful initialization
        setTimeout(() => {
            if (isInitialized) {
                startConnectionMonitoring();
                debugLog('Connection monitoring started');
            }
        }, 5000);

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            stopConnectionMonitoring();
            if (mqttClient && mqttClient.isConnected()) {
                try {
                    mqttClient.disconnect();
                } catch (error) {
                    console.log('Error disconnecting MQTT on unload:', error);
                }
            }
        });

        // Handle browser notification permission changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, check if notification permission changed
                if (Notification.permission !== notificationPermission) {
                    notificationPermission = Notification.permission;
                    updateNotificationUI();
                    debugLog(`Notification permission changed to: ${notificationPermission}`);
                }
            }
        });

        // Service Worker registration for enhanced notification support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // You can register a service worker here for more advanced notification features
                debugLog('Service Worker support detected');
            });
        }

        // Notification sound (optional - you can add sound effects)
        function playNotificationSound(type = 'default') {
            // You can add audio elements or use Web Audio API for notification sounds
            // For now, we'll use a simple beep for critical notifications
            if (type === 'critical' || type === 'danger') {
                // Create a simple beep sound using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // Frequency in Hz
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    debugLog('Audio notification failed: ' + error.message);
                }
            }
        }

    </script>

<!-- Floating Toast Container -->
<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 2000;"></div>

</body>
</div>
</html>
